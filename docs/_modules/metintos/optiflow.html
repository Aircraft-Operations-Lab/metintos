
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>metintos.optiflow &#8212; METINTOS 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for metintos.optiflow</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span> <span class="nn">metintos.utils</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="NormalizedWrappedInterpolant"><a class="viewcode-back" href="../../code.html#metintos.optiflow.NormalizedWrappedInterpolant">[docs]</a><span class="k">class</span> <span class="nc">NormalizedWrappedInterpolant</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;2D interpolant with natural index coordinates</span>

<span class="sd">        :var array: 2D array to interpolate</span>
<span class="sd">        :type array: array_like</span>

<span class="sd">        :var i: normalized coordinates along the first axis</span>
<span class="sd">        :type i: array_like</span>

<span class="sd">        :var j: normalized coordinates along the second axis</span>
<span class="sd">        :type j: array_like</span>

<span class="sd">        :var interpolant: wrapped interpolant</span>
<span class="sd">        :type interpolant: R² -&gt; R mapping</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NormalizedWrappedInterpolant.__init__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.NormalizedWrappedInterpolant.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">interpolant_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param array: 2D array to interpolate</span>
<span class="sd">            :type array: array_like</span>

<span class="sd">            :param interpolant_generator: wrapped interpolant</span>
<span class="sd">            :type interpolant_generator: R² -&gt; (R² -&gt; R) mapping</span>

<span class="sd">            :returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">interpolant_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interpolant_generator</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span> <span class="o">=</span> <span class="n">interpolant_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span></div>

<div class="viewcode-block" id="NormalizedWrappedInterpolant.__call__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.NormalizedWrappedInterpolant.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param args:</span>
<span class="sd">            :type args:</span>

<span class="sd">            :param kwargs:</span>
<span class="sd">            :type kwargs:</span>

<span class="sd">            :returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="NormalizedWrappedInterpolant.ev"><a class="viewcode-back" href="../../code.html#metintos.optiflow.NormalizedWrappedInterpolant.ev">[docs]</a>    <span class="k">def</span> <span class="nf">ev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param args:</span>
<span class="sd">            :type args:</span>

<span class="sd">            :param kwargs:</span>
<span class="sd">            :type kwargs:</span>

<span class="sd">            :returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TwoFrameInterpolant"><a class="viewcode-back" href="../../code.html#metintos.optiflow.TwoFrameInterpolant">[docs]</a><span class="k">class</span> <span class="nc">TwoFrameInterpolant</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs optical flow or linear interpolation between two consecutive frames</span>

<span class="sd">        :var start_frame: Matrix representation of the variable at the start of the temporal interpolation domain</span>
<span class="sd">        :type start_frame: 2D array</span>

<span class="sd">        :var end_frame: Matrix representation of the variable at the end of the temporal interpolation</span>
<span class="sd">        :type end_frame: 2D array</span>

<span class="sd">        :var flow_calculator: Callable that computes the optical flow between two frames / arrays</span>
<span class="sd">        :type flow_calculator: (R² x R²) -&gt; R² mapping</span>

<span class="sd">        :var spatial_interp: Callable that generates a 2D interpolant of a frame array with normalized coordinates</span>
<span class="sd">        :type spatial_interp: R² -&gt; (R² -&gt; R)</span>

<span class="sd">        :var flow: Optical flow between the start and end frames</span>
<span class="sd">        :type flow: 2D array (R²)</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TwoFrameInterpolant.__init__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.TwoFrameInterpolant.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">,</span> <span class="n">flow_calculator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_interp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_flow</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param start_frame: 2D array representation of the variable at the start of the temporal interpolation domain</span>
<span class="sd">            :type start_frame: array_like</span>

<span class="sd">            :param end_frame: 2D array representation of the variable at the end of the temporal interpolation</span>
<span class="sd">            :type end_frame: array_like</span>

<span class="sd">            :param flow_calculator: Callable that computes the optical flow between two frames / arrays</span>
<span class="sd">            :type flow_calculator: (R² x R²) -&gt; R² mapping</span>

<span class="sd">            :param spatial_interp: Callable that generates a 2D interpolant of a frame array with normalized coordinates</span>
<span class="sd">            :type spatial_interp: R² -&gt; (R² -&gt; R)</span>

<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spatial_interp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spatial_interp</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span>
        <span class="k">if</span> <span class="n">flow_calculator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flow_calculator</span> <span class="o">=</span> <span class="n">FarnebackFlow</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">end_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start_frame and end_frame must have the same shape; instead, they have shapes &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">end_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input frames with shape </span><span class="si">{</span><span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> are not 2D&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="o">=</span> <span class="n">start_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span> <span class="o">=</span> <span class="n">end_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_calculator</span> <span class="o">=</span> <span class="n">flow_calculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_interp</span> <span class="o">=</span> <span class="n">spatial_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_calculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span> <span class="n">initial_flow</span><span class="p">)</span>
        <span class="n">r_initial_flow</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">initial_flow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="n">initial_flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_r</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_calculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">r_initial_flow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I_start</span> <span class="o">=</span> <span class="n">NormalizedWrappedInterpolant</span><span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">spatial_interp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I_end</span> <span class="o">=</span> <span class="n">NormalizedWrappedInterpolant</span><span class="p">(</span><span class="n">end_frame</span><span class="p">,</span> <span class="n">spatial_interp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I_start</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_start</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="TwoFrameInterpolant.__call__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.TwoFrameInterpolant.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param t: Fraction of the time domain between the start and the end frame. Must fulfill 0 &lt;= t &lt;= 1</span>
<span class="sd">            :type t: float</span>

<span class="sd">            :returns: Flow-interpolated array at t</span>
<span class="sd">            :rtype: array_like</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The temporal fraction for optical flow interpolation must lie between 0 and 1&quot;</span><span class="p">)</span>

        <span class="n">ii_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ii</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span><span class="p">)</span>
        <span class="n">jj_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j_max</span><span class="p">)</span>
        <span class="n">ii_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ii</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span><span class="p">)</span>
        <span class="n">jj_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j_max</span><span class="p">)</span>

        <span class="n">start_translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_start</span><span class="p">(</span><span class="n">ii_start</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">jj_start</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">end_translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_end</span><span class="p">(</span><span class="n">ii_end</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">jj_end</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="n">end_translated</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">start_translated</span></div></div>


<div class="viewcode-block" id="MultiFrameInterpolant"><a class="viewcode-back" href="../../code.html#metintos.optiflow.MultiFrameInterpolant">[docs]</a><span class="k">class</span> <span class="nc">MultiFrameInterpolant</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs optical flow or linear interpolation between several consecutive, equally spaced frames</span>

<span class="sd">        :var interpolants: List of pairwise interpolants</span>
<span class="sd">        :type interpolants: List[TwoFrameInterpolant]</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MultiFrameInterpolant.__init__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.MultiFrameInterpolant.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">flow_calculator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_interp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_flows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param frames: List of 2D arrays</span>
<span class="sd">            :type frames: list[array_like]</span>

<span class="sd">            :param flow_calculator: Callable that computes the optical flow between two frames / arrays</span>
<span class="sd">            :type flow_calculator: (R² x R²) -&gt; R² mapping</span>

<span class="sd">            :param spatial_interp: Callable that generates a 2D interpolant of a frame array with normalized coordinates</span>
<span class="sd">            :type spatial_interp: R² -&gt; (R² -&gt; R)</span>

<span class="sd">            :param t_axis: (optional) array containing the timestamps of t</span>
<span class="sd">            :type t_axis: array_like(dtype=&#39;timedelta64&#39;)</span>

<span class="sd">            :param initial_flows: List of arrays of shape N x M x 2 representing initial guesses for the optical flows</span>
<span class="sd">            :type initial_flows: list[array_like]</span>

<span class="sd">            :returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">initial_flows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initial_flows</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span> <span class="o">=</span> <span class="n">t_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolants</span> <span class="o">=</span> <span class="p">[</span><span class="n">TwoFrameInterpolant</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">next_frame</span><span class="p">,</span> <span class="n">flow_calculator</span><span class="p">,</span> <span class="n">spatial_interp</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">prev_frame</span><span class="p">,</span> <span class="n">next_frame</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">initial_flows</span><span class="p">)]</span></div>

<div class="viewcode-block" id="MultiFrameInterpolant.__call__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.MultiFrameInterpolant.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param t: Fraction of the time domain between the start and the end frame. Must fulfill 0 &lt;= t &lt;= n_frames</span>
<span class="sd">            :type t: float</span>

<span class="sd">            :returns: Flow-interpolated array at t</span>
<span class="sd">            :rtype: array_like</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The temporal fraction must lie between 0 and n - 1, where n is the number of frames&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t_frac</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">i</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolants</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">t_frac</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiFrameInterpolant.eval_at_t"><a class="viewcode-back" href="../../code.html#metintos.optiflow.MultiFrameInterpolant.eval_at_t">[docs]</a>    <span class="k">def</span> <span class="nf">eval_at_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">check_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            :param t: Union[np.datetime64, np.timedelta64]</span>
<span class="sd">            :type t:</span>

<span class="sd">            :param check_nans: if True, replace any nans in the input with zeros</span>
<span class="sd">            :type check_nans: bool</span>

<span class="sd">            :returns:  Flow-interpolated array at timestamp t</span>
<span class="sd">            :rtype: array_like</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> instance was not initialized with a temporal axis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The timestamp </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> is below the lower temporal axis bound of </span><span class="si">{</span><span class="n">lower_bound</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The timestamp </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> is below the upper temporal axis bound of </span><span class="si">{</span><span class="n">upper_bound</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">idx_low</span><span class="p">,</span> <span class="n">idx_high</span> <span class="o">=</span> <span class="n">get_bracketing_indexes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">t_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]</span>
        <span class="n">t_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_axis</span><span class="p">[</span><span class="n">idx_low</span><span class="p">]</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_low</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_high</span> <span class="o">-</span> <span class="n">t_low</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">frac</span>
        <span class="k">assert</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">frac</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolants</span><span class="p">[</span><span class="n">idx_low</span><span class="p">](</span><span class="n">frac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_nans</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">output</span></div></div>


<div class="viewcode-block" id="FarnebackFlow"><a class="viewcode-back" href="../../code.html#metintos.optiflow.FarnebackFlow">[docs]</a><span class="k">class</span> <span class="nc">FarnebackFlow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Optical flow calculator using the algorithm of Farneback (2003)</span>

<span class="sd">        :var parameters: arguments passed to the Farneback algorithm</span>
<span class="sd">        :type parameters: dict</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FarnebackFlow.__init__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.FarnebackFlow.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optical flow calculator using the algorithm of Farneback (2003)</span>

<span class="sd">            :param kwargs: arguments passed to the Farneback algorithm</span>
<span class="sd">            :type kwargs: dict</span>

<span class="sd">            :returns: None</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                           <span class="s1">&#39;poly_n&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                           <span class="s1">&#39;poly_sigma&#39;</span><span class="p">:</span> <span class="mf">1.934</span><span class="p">,</span>
                           <span class="s1">&#39;pyr_scale&#39;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
                           <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">,</span>
                           <span class="s1">&#39;winsize&#39;</span><span class="p">:</span> <span class="mi">77</span><span class="p">,</span>
                           <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">OPTFLOW_FARNEBACK_GAUSSIAN</span>
                           <span class="p">}</span>
        <span class="c1"># self.parameters = {&#39;pyr_scale&#39;: 0.5,</span>
        <span class="c1">#                    &#39;levels&#39;: 5,</span>
        <span class="c1">#                    &#39;winsize&#39;: 100,</span>
        <span class="c1">#                    &#39;iterations&#39;: 4,</span>
        <span class="c1">#                    &#39;poly_n&#39;: 9,</span>
        <span class="c1">#                    &#39;poly_sigma&#39;: 1.6,</span>
        <span class="c1">#                    &#39;flags&#39;: cv2.OPTFLOW_FARNEBACK_GAUSSIAN,</span>
        <span class="c1">#                    &#39;scale&#39;: 1e5}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;levels&#39;</span><span class="p">,</span> <span class="s1">&#39;winsize&#39;</span><span class="p">,</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="s1">&#39;poly_n&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="FarnebackFlow.__call__"><a class="viewcode-back" href="../../code.html#metintos.optiflow.FarnebackFlow.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">,</span> <span class="n">initial_flow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the computed optical flow</span>

<span class="sd">            :param start_frame: 2D array (N x M) representing the start frame</span>
<span class="sd">            :type start_frame: array_like</span>

<span class="sd">            :param end_frame: 2D array (N x M) representing the end frame</span>
<span class="sd">            :type end_frame: array_like</span>

<span class="sd">            :param initial_flow: (optional) N x M x 2 array to initialize the flow</span>
<span class="sd">            :type initial_flow: array_like or None</span>

<span class="sd">            :param start_frame: 2D array (N x M) representing the start frame</span>
<span class="sd">            :type start_frame: array_like</span>

<span class="sd">            :param check_nans: (optional) if True, replace any nans in the input with zeros</span>
<span class="sd">            :type check_nans: bool</span>

<span class="sd">            :returns: optical flow between the frames</span>
<span class="sd">            :rtype: array_like</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowFarneback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">start_frame</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">end_frame</span><span class="p">,</span>
                                            <span class="n">initial_flow</span><span class="p">,</span>
                                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_nans</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">flow</span></div></div>


<span class="k">class</span> <span class="nc">DummyFlow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">,</span> <span class="n">initial_flow</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">start_frame</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">METINTOS</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=javiergarciaheras&repo=metintos&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Optical Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-metintos.isa">International Standard Atmosphere (ISA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-metintos.utils">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-metintos.io">Input/output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-metintos.constants">Constants</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, UC3M <dangonza@ing.uc3m.es>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>